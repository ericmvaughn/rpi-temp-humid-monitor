<html>
  <head>
    <style>
        .flex
          {
              display: flex;
              flex-direction: row;
          }
    </style>
    <!--Load the AJAX API-->
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script type="text/javascript">
    
    // Load the Visualization API and the piechart package.
    google.load('visualization', '1', {'packages':['annotationchart','gauge']});
      
    // Set a callback to run when the Google Visualization API is loaded.
    google.setOnLoadCallback(drawChart);
      
    function drawChart() {
      var jsonData = $.ajax({
        url: "getData.php",
        dataType:"json",
        async: false
        }).responseText;
          
      // Create our data table out of JSON data loaded from server.
      //console.log("creating data table");
      var data = new google.visualization.DataTable(jsonData);

      // Instantiate and draw our chart, passing in some options.
      var chart = new google.visualization.AnnotationChart(document.getElementById('chart_div'));
      var gauge = new google.visualization.Gauge(document.getElementById('gauge_div'));
    
      // set up a formater
      var formatter = new google.visualization.NumberFormat(
           {fractionDigits: 1});

 
      // assumes you have timestamps in column 0, and two data series (columns 1 and 2)
      var view = new google.visualization.DataView(data);
      view.setColumns([{
        type: 'datetime',
        label: data.getColumnLabel(0),
        calc: function (dt, row) {
          var timestamp = dt.getValue(row, 0) * 1000; // convert to milliseconds
          return new Date(timestamp);
        }
      }, 
        {
        type: 'number',
        label: data.getColumnLabel(1),
        calc: function (dataTable, rowNumber) {
           return Number(dataTable.getValue(rowNumber, 1))}  
        },  
        {
        type: 'number',
        label: data.getColumnLabel(2),
        calc: function (dataTable, rowNumber) {
           return Number(dataTable.getValue(rowNumber, 2))}  
        },  
        {
        type: 'number',
        label: data.getColumnLabel(3),
        calc: function (dataTable, rowNumber) {
           return Number(((dataTable.getValue(rowNumber, 3)/120/15)*100).toFixed(1))}  //convert to a percentage of total power more or less...
        }
        ]);

      var options = {
        title: 'Temperature and Relative Humidity over Time',      	
        width: 900,
        height: 600,
        mas: 100,
        displayZoomButtons: 'true',

        series: {
           0: { color: 'blue', lineWidth: 1},
           1: { color: 'green', lineWidth: 1},
           2: { color: 'red', lineWidth: 0.2}
          },        
/*        series: {
            // Gives each series an axis name that matches the Y-axis below.
            0: {axis: 'Temperature'},
            1: {axis: 'Power'}
          },
        axes: {
            // Adds labels to each axis; they don't have to match the axis names.
            y: {
              Temperature: {label: 'Temps'},
              Power: {label: 'Power'}
            }
          }
*/
        vAxis: {title: "Temperature (F), Humidity (%) and Power (%) ", viewWindow: {max: 100, min: 0}, gridlines:{count: 11}},
        hAxis: {title: "Date and Time"},
//        chartArea: {'width': '100%', 'height': '80%'},
      }  

      //chart.draw(view, google.charts.Line.convertOptions(options));
      chart.draw(view, options);

      rows = view.getNumberOfRows();
      temp = Number(view.getValue(rows - 1, 1));
      humid = Number(view.getValue(rows - 1, 2));
      power = Number(view.getValue(rows - 1, 3));
      console.log(rows,temp, humid, power);

      var gauge_data = google.visualization.arrayToDataTable([
          ['Label', 'Value'],
          ['Temperature', temp],
          ['Humidity', humid],
          ['Power', power]
        ]);


      var gauge_options = {
          width: 200, height: 800,
          redFrom: 0, redTo: 20,
          yellowFrom:80, yellowTo: 100,
          majorTicks: ['0','','20','','40','','60','','80','','100'],
          minorTicks: 2
        };

      gauge.draw(gauge_data, gauge_options);

    }

    function heater(on){

    }

    </script>

    <script type="text/javascript" src="jQuery.js"></script>
    <script type="text/javascript">
      $(document).ready(function(){
        // First load the chart once 
        //console.log("calling drawChart");
        drawChart();
        // Set interval to call the drawChart again
        setInterval(drawChart, 300000);
      });
    </script>

  </head>

  <body>
    <!--Div that will hold the line chart-->
    <div class="flex">
        <div id="gauge_div" style="margin-top: 20px; margin-right: 20px;" ></div>
        <div id="chart_div" style="margin-top: 10px; margin-left: 20px;"></div>
    </div>
        <input type="button" value="Heat on" onclick="heater(1)" />
        <input type="button" value="Heat off" onclick="heater(0)" />
  </body>
</html>
